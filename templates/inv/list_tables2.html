{% load render_table from django_tables2 %}
{% load django_tables2 %}

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Laboratory inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>    
    .table-wrap {
      overflow: auto;
      max-height: 70vh;
      border-radius: 0.5rem;
    }
    
    table.table {
        margin-bottom: 0;
        border-collapse: separate;
        border-spacing: 0;
        }

    table.table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: #f8f9fb;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        font-size: 0.82rem;
        padding: .45rem .6rem;
        white-space: nowrap;
        }
    
    table.table tbody td {
        font-size: 0.82rem;
        padding: .40rem .6rem;
        border-bottom: 1px solid #eef1f5;
        vertical-align: middle;
        }
        
    table.table tbody tr:hover {
        background: #f6f9ff;
        }

    table.table td, table.table th {
      border-right: 1px solid #f0f2f6;
        }
    table.table td:last-child, table.table th:last-child {
      border-right: none;
        }

    table.table thead th.orderable {
        position: sticky;
        top: 0;
        padding-right: 1.5rem;
        }
    table.table thead th.orderable::after {
        content: "⇅";
        position: absolute;
        right: .45rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: .75rem;
        opacity: .35;
        }
    table.table thead th.orderable.asc::after {
        content: "▲";
        opacity: .85;
        }
    table.table thead th.orderable.desc::after {
        content: "▼";
        opacity: .85;
        }
        
    table.table thead th a {
        color: #212529;
        text-decoration: none;
        }
    table.table thead th a:hover {
        text-decoration: underline;
        }
   
    .tight-col {
      width: 1%;
      white-space: nowrap;
    }
 
    table.table tbody td:nth-child(5) {
        max-width: 360px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        }
    
    .btn-group > form:last-child .btn {
        border-top-left-radius: 0 !important;
        border-bottom-left-radius: 0 !important;
    }
    
    .btn-sep{
        width: 0.4px;
        background: transparent;
        display: inline-block;
    }

    tr:target {
        background: #fff3cd !important;
        border-top: 2px solid #ffd966 !important;
        border-bottom: 2px solid #ffd966 !important;
    }

    tr:target td {
        box-shadow: inset 0 -1px 0 #ffd966, inset 0 1px 0 #ffd966;
    }

    .table-wrap {
        padding-bottom: 0;
    }

    .table-footer{
        border-top: 1px solid #eef1f5;
        background: #fff;
        margin-top: 8px;
    }

    .table-container .pagination{
        margin: 0.08rem;                
    }

    .pager-bar {
        border-top: none !important;
        background: #fff;
    }

    .pager-label {
        font-size: .85rem;
        color: #6c757d;
        white-space: nowrap;
    }

    .pager-range {
        font-size: .85rem;
        color: #212529;
        white-space: nowrap;
    }

    .pager-select {
        border: 1px solid #cfd4da;
        border-radius: .35rem;
        padding: .25rem .5rem;
        font-size: .85rem;
        background: #fff;
    }

    .pager-icons {
        display: inline-flex;
        align-items: center;
        gap: .65rem;
    }

    .pager-icon {
        font-size: 1.2rem;
        color: #6c757d;
        cursor: pointer;
        user-select: none;
    }

    .pager-icon:hover {
        color: #212529;
    }

    .pager-icon.disabled {
        opacity: .35;
        cursor: default;
    }

    .pager-nav a {
        text-decoration: none;
        color: inherit;
    }

    .table-container nav[aria-label="Table navigation"] {
        display: none !important;
    }


  </style>
</head>

<body class="p-4">
  <div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="m-2">Laboratory inventory</h2>
    </div>

    <!-- Toolbar -->
    <div class="d-flex justify-content-between align-items-center gap-2 mb-3">

      <!-- New item + Save filters -->
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-primary btn-sm" href="{% url 'inv:create' %}">
          <i class="bi bi-plus-lg me-1"></i> New item
        </a>

        <button class="btn btn-outline-secondary btn-sm" type="button" disabled>
          <i class="bi bi-bookmark me-1"></i> Save filters
        </button>
      </div>

      <!-- Search + Filter icon -->
      <div class="d-flex align-items-center gap-2">

        <!-- Search form (q) -->
        <form method="get" class="d-flex align-items-center gap-2 m-0">
          {# Mantener filtros actuales al buscar #}
          {% if request.GET.type %}<input type="hidden" name="type" value="{{ request.GET.type }}">{% endif %}
          {% if request.GET.supplier %}<input type="hidden" name="supplier" value="{{ request.GET.supplier }}">{% endif %}

          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input
              type="text"
              class="form-control"
              name="q"
              value="{{ request.GET.q|default:'' }}"
              placeholder="Description contains">
          </div>

          <button class="btn btn-outline-primary btn-sm" type="submit">Search</button>
        </form>

        <!-- Filter button -->
        <button class="btn btn-outline-secondary btn-sm" type="button"
                data-bs-toggle="modal" data-bs-target="#filterModal"
                title="Filters">
          <i class="bi bi-funnel"></i>
        </button>

        <!-- Clear button -->
        <a class="btn btn-outline-secondary btn-sm"
            href="{% url 'inv:list' %}"
            title="Clear">
            <i class="bi bi-x-circle"></i>
        </a>

      </div>
    </div>

    <!-- Table -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-wrap">
                {% render_table table %}
            </div>

            <!-- FOOTER -->
            {% if table.page and table.paginator.count > 0 %}
            {% with first_page='1' last_page=table.paginator.num_pages %}
            <div class="pager-bar d-flex justify-content-end align-items-center gap-3 px-3 py-2">

                <!-- Rows per page -->
                <form method="get" class="d-flex align-items-center gap-2 m-0">
                    {# Mantener params (q, filtros, sort), pero resetear page al cambiar per_page #}
                    {% for key, value in request.GET.items %}
                        {% if key != "per_page" and key != "page" %}
                            <input type="hidden" name="{{ key }}" value="{{ value }}">
                        {% endif %}
                    {% endfor %}

                    <span class="pager-label">Rows per page</span>
                    <select name="per_page" class="pager-select" onchange="this.form.submit()">
                        <option value="10"  {% if request.GET.per_page == "10" or not request.GET.per_page %}selected{% endif %}>10</option>
                        <option value="25"  {% if request.GET.per_page == "25" %}selected{% endif %}>25</option>
                        <option value="50"  {% if request.GET.per_page == "50" %}selected{% endif %}>50</option>
                        <option value="75"  {% if request.GET.per_page == "75" %}selected{% endif %}>75</option>
                        <option value="100" {% if request.GET.per_page == "100" %}selected{% endif %}>100</option>
                    </select>
                </form>

                <!-- Range text: 1–25 of 100 -->
                <div class="pager-range">
                    {{ table.page.start_index }}–{{ table.page.end_index }} of {{ table.paginator.count }}
                </div>

                <!-- Pagination buttons (icons only) -->
                <nav class="pager-nav" aria-label="Pagination">
                    <div class="pager-icons">

                        {# First #}
                        {% if table.page.number > 1 %}
                            <a class="pager-link" href="{% querystring table.prefixed_page_field=first_page %}">
                                <span class="pager-icon" title="First">|&lt;</span>
                            </a>
                        {% else %}
                            <span class="pager-icon disabled" title="First">|&lt;</span>
                        {% endif %}

                        {# Prev #}
                        {% if table.page.has_previous %}
                            <a class="pager-link" href="{% querystring table.prefixed_page_field=table.page.previous_page_number %}">
                                <span class="pager-icon" title="Previous">&lt;</span>
                            </a>
                        {% else %}
                            <span class="pager-icon disabled" title="Previous">&lt;</span>
                        {% endif %}

                        {# Next #}
                        {% if table.page.has_next %}
                            <a class="pager-link" href="{% querystring table.prefixed_page_field=table.page.next_page_number %}">
                                <span class="pager-icon" title="Next">&gt;</span>
                            </a>
                        {% else %}
                            <span class="pager-icon disabled" title="Next">&gt;</span>
                        {% endif %}

                        {# Last #}
                        {% if table.page.number < table.paginator.num_pages %}
                            <a class="pager-link" href="{% querystring table.prefixed_page_field=last_page %}">
                                <span class="pager-icon" title="Last">&gt;|</span>
                            </a>
                        {% else %}
                            <span class="pager-icon disabled" title="Last">&gt;|</span>
                        {% endif %}

                    </div>
                </nav>
            </div>
            {% endwith %}
            {% endif %}
        </div>
    </div>
  </div>
  
  <!-- Filter Modal -->
  <div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Filters</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form method="get" class="modal-body">
          {# Mantener búsqueda actual al filtrar #}
          {% if request.GET.q %}<input type="hidden" name="q" value="{{ request.GET.q }}">{% endif %}

          <div class="mb-3">
            <label class="form-label">Assigned bench</label>
            {{ filter.form.assigned_bench }}
          </div>

          <div class="mb-3">
            <label class="form-label">Type</label>
            {{ filter.form.type }}
          </div>

          <div class="mb-3">
            <label class="form-label">Supplier</label>
            {{ filter.form.supplier }}
          </div>

          <div class="mb-3">
            <label class="form-label">Status</label>
            {{ filter.form.status }}
          </div>

          <div class="d-flex justify-content-between align-items-center">
            <a class="btn btn-link btn-sm" href="{% url 'inv:list' %}">Clear</a>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary btn-sm">Show results</button>
            </div>
          </div>
        </form>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>